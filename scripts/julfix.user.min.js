// ==UserScript==
// @name         JULFIX-minimal
// @namespace    https://github.com/L0wl/JULFIX
// @version      0.0.6
// @description  Fix repo downloading issues, just by one click
// @author       L0wl
// @homepageURL  https://github.com/L0wl/julfix
// @match        https://jules.google.com/*
// @icon         https://www.gstatic.com/labs-code/code-app/favicon-32x32.png
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js
// @updateURL    https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @downloadURL  https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @supportURL   https://github.com/L0wl/julfix/issues
// @grant        none
// @run-at       document-body
// @sandbox      ISOLATED_WORLD
// @unwrap
// ==/UserScript==

!function(){"use strict";const e=/\/(?:u\/\d+\/)?task\/\d+$/;let t=location.pathname,o=null,n=null;const i="Download",c=".panel-button-right-container",r=".nav-button";function l(){if(o)return;const e=document.querySelector(c),t=e?.querySelector(r);let l=null;if(o=document.createElement("button"),e&&t){l=e,Array.from(t.attributes).forEach((e=>{o.setAttribute(e.name,e.value)})),o.className=t.className;const n=document.createElement("span");n.textContent=i,o.appendChild(n)}else l=document.body,o.textContent=i,o.style='position: fixed; bottom: 20px; right: 20px; z-index: 9999; padding: 8px 13px; background-color: #28252b; font-size: 1rem; display: flex; font-weight: 400; font-family: "Google Sans", ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji"; color: #e6e1ff; border: 1px solid #3a353f; border-radius: 6px; cursor: pointer;';o.addEventListener("click",(async function(){await async function(){const e=new JSZip,t=monaco.editor.getDiffEditors(),o=/^\/modified\/\d+\/\d+\//,i="modified/cumulative/";let c=0;for(let n of t)try{const t=n.getModel();if(t&&t.modified&&"function"==typeof t.modified.isDisposed&&!t.modified.isDisposed()){const n=t.modified.getValue();let r=t.modified.uri.path.replace(o,"");if(r.startsWith("/")&&(r=r.slice(1)),r.startsWith(i))continue;r&&(e.file(r,n),c++)}}catch{}if(0===c)return;const r=await e.generateAsync({type:"blob"}),l=document.createElement("a"),a=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);l.href=URL.createObjectURL(r),l.download=null!==n?`${n}_${a}.zip`:`jules_sources_${a}.zip`,document.body.appendChild(l),l.click(),document.body.removeChild(l),URL.revokeObjectURL(l.href)}()})),l.appendChild(o)}function a(){if(o&&(o.remove(),o=null),!e.test(location.pathname))return;const t=setInterval((()=>{"undefined"!=typeof monaco&&void 0!==monaco.editor&&"function"==typeof monaco.editor.getDiffEditors&&(clearInterval(t),function(e,t=15e3){const o=Date.now(),i=new MutationObserver((()=>{null!==document.querySelector(".content-body")&&null!==document.querySelector(".code-panel")&&null!==document.querySelector(".monaco-diff-editor")&&null!==document.querySelector(".source-text-repo")&&null!==document.querySelector(".source-text-org")&&monaco?.editor?.getDiffEditors?.().length>0?(i.disconnect(),n=document.querySelector(".source-text-repo")?.textContent,e()):Date.now()-o>t&&(i.disconnect(),n=null)}));i.observe(document.body,{childList:!0,subtree:!0})}((()=>{l()})))}),5e3)}!function(){const e=history.pushState,o=history.replaceState;function n(){location.pathname!==t&&(t=location.pathname,a())}history.pushState=function(...t){e.apply(this,t),n()},history.replaceState=function(...e){o.apply(this,e),n()},window.addEventListener("popstate",n)}(),a()}();