// ==UserScript==
// @name         JULFIX-minimal
// @namespace    https://github.com/L0wl/JULFIX
// @version      0.0.2
// @description  Fix repo downloading issues, just by one click
// @author       L0wl
// @homepageURL  https://github.com/L0wl/julfix
// @match        https://jules.google.com/*
// @icon         https://www.gstatic.com/labs-code/code-app/favicon-32x32.png
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js
// @updateURL    https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @downloadURL  https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @supportURL   https://github.com/L0wl/julfix/issues
// @grant        none
// @run-at       document-body
// @sandbox      ISOLATED_WORLD
// @unwrap
// ==/UserScript==

!async function(){"use strict";let t=location.pathname,e=null,n=null,o=null;const i=/^\/task\/\d+$/;function c(){return i.test(location.pathname)}function d(){e||(e=document.createElement("button"),e.textContent="Download ZIP",e.style="\nposition: fixed;\nbottom: 20px;\nright: 20px;\nz-index: 9999;\npadding: 10px 15px;\nbackground-color:rgba(0, 0, 0, 0.5);\nopacity: 50%;\ncolor: white;\nborder: none;\nborder-radius: 5px;\ncursor: pointer;\nbox-shadow: 0 2px 5px rgba(0,0,0,0.2);\n",e.addEventListener("click",(async function(){!async function(){const t=new JSZip,e=monaco.editor.getDiffEditors(),n=/^\/modified\/\d+\/\d+\//,o="modified/cumulative/";let i=0;for(let c of e)try{const e=c.getModel();if(e&&e.modified&&"function"==typeof e.modified.isDisposed&&!e.modified.isDisposed()){const c=e.modified.getValue();let d=e.modified.uri.path.replace(n,"");if(d.startsWith("/")&&(d=d.slice(1)),d.startsWith(o))continue;d&&(t.file(d,c),i++)}}catch{}if(0===i)return;const c=await t.generateAsync({type:"blob"}),d=document.createElement("a"),a=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);d.href=URL.createObjectURL(c),d.download=`jules_modified_code_${a}.zip`,document.body.appendChild(d),d.click(),document.body.removeChild(d),URL.revokeObjectURL(d.href)}()})),document.body.appendChild(e))}function a(){e&&(e.remove(),e=null)}function r(){o&&clearInterval(o),n&&n.disconnect(),o=setInterval((()=>{c()&&"undefined"!=typeof monaco&&void 0!==monaco.editor&&"undefined"!=typeof JSZip&&function(){try{return monaco.editor.getDiffEditors().length}catch{return 0}}()>0?d():a()}),750),n=new MutationObserver((()=>{c()||a()})),n.observe(document.body,{childList:!0,subtree:!1})}function s(){o&&clearInterval(o),n&&n.disconnect(),a(),c()&&r()}!function(){const e=history.pushState,n=history.replaceState;function o(){location.pathname!==t&&(t=location.pathname,s())}history.pushState=function(...t){e.apply(this,t),o()},history.replaceState=function(...t){n.apply(this,t),o()},window.addEventListener("popstate",o)}(),s()}();