// ==UserScript==
// @name         JULFIX-minimal
// @namespace    https://github.com/L0wl/JULFIX
// @version      0.0.5
// @description  Fix repo downloading issues, just by one click
// @author       L0wl
// @homepageURL  https://github.com/L0wl/julfix
// @match        https://jules.google.com/*
// @icon         https://www.gstatic.com/labs-code/code-app/favicon-32x32.png
// @require      https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js
// @updateURL    https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @downloadURL  https://github.com/L0wl/julfix/raw/refs/heads/master/scripts/julfix.user.min.js
// @supportURL   https://github.com/L0wl/julfix/issues
// @grant        none
// @run-at       document-body
// @sandbox      ISOLATED_WORLD
// @unwrap
// ==/UserScript==

!function(){"use strict";const e=/\/(?:u\/\d+\/)?task\/\d+$/;let t=location.pathname,n=null,o=null,c=null;const i="Download",r="Hide Code",d="Show Code",s=".panel-button-right-container",a=".nav-button";let l=null;function u(){if(n)return;const e=document.querySelector(s),t=e?.querySelector(a);let o=null;if(n=document.createElement("button"),e&&t){o=e,Array.from(t.attributes).forEach((e=>{n.setAttribute(e.name,e.value)})),n.className=t.className;const c=document.createElement("span");c.textContent=i,n.appendChild(c)}else o=document.body,n.textContent=i,n.style='position: fixed; bottom: 20px; right: 20px; z-index: 9999; padding: 8px 13px; background-color: #28252b; font-size: 1rem; display: flex; font-weight: 400; font-family: "Google Sans", ui-sans-serif, system-ui, sans-serif; color: #e6e1ff; border: 1px solid #3a353f; border-radius: 6px; cursor: pointer;';n.addEventListener("click",(async function(){await async function(){const e=new JSZip,t=monaco.editor.getDiffEditors(),n=/^\/modified\/\d+\/\d+\//,o="modified/cumulative/";let c=0;for(let i of t)try{const t=i.getModel();if(t&&t.modified&&"function"==typeof t.modified.isDisposed&&!t.modified.isDisposed()){const i=t.modified.getValue();let r=t.modified.uri.path.replace(n,"");if(r.startsWith("/")&&(r=r.slice(1)),r.startsWith(o))continue;r&&(e.file(r,i),c++)}}catch{}if(0===c)return;const i=await e.generateAsync({type:"blob"}),r=document.createElement("a"),d=(new Date).toISOString().replace(/[:.]/g,"-").slice(0,19);r.href=URL.createObjectURL(i),r.download=l?`${l}_${d}.zip`:`jules_sources_${d}.zip`,document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(r.href)}()})),o.appendChild(n)}function m(){null!==document.querySelector(".code-header.shown")?function(){const e=document.querySelector(".code-header.shown");e&&(e.className=e.className.replace("shown","hidden"));const t=document.querySelector(".code-container.shown");t&&(t.className=t.className.replace("shown","hidden"));const n=document.querySelector(".chat-container.selected");n&&(n.style.width="100%");c&&(c.textContent=d)}():function(){const e=document.querySelector(".code-header.hidden");e&&(e.className=e.className.replace("hidden","shown"));const t=document.querySelector(".code-container.hidden");t&&(t.className=t.className.replace("hidden","shown"));const n=document.querySelector(".chat-container.selected");n&&(n.style.width="");c&&(c.textContent=r)}()}function f(){if(n&&(n.remove(),n=null),o&&(o.remove(),o=null),!e.test(location.pathname))return;const t=setInterval((()=>{"undefined"!=typeof monaco&&void 0!==monaco.editor&&"function"==typeof monaco.editor.getDiffEditors&&(clearInterval(t),function(e,t=15e3){const n=Date.now(),o=new MutationObserver((()=>{null!==document.querySelector(".content-body")&&null!==document.querySelector(".code-panel")&&null!==document.querySelector(".monaco-diff-editor")&&null!==document.querySelector(".source-text-repo")&&null!==document.querySelector(".source-text-org")&&monaco?.editor?.getDiffEditors?.().length>0?(o.disconnect(),l=document.querySelector(".source-text-repo")?.textContent,e()):Date.now()-n>t&&(o.disconnect(),l=null)}));o.observe(document.body,{childList:!0,subtree:!0})}((()=>{u(),o||(o=document.createElement("button"),o.style='position: fixed; bottom: 8px; right: 8px; z-index: 9999; padding: 8px 13px; background-color: #28252b; font-size: 1rem; display: flex; font-weight: 400; white-space: nowrap; font-family: "Google Sans", ui-sans-serif, system-ui, sans-serif; color: #e6e1ff; border: 1px solid #3a353f; border-radius: 6px; cursor: pointer;',c=document.createElement("span"),c.textContent=r,o.appendChild(c),o.addEventListener("click",m),document.body.appendChild(o))})))}),5e3)}!function(){const e=history.pushState,n=history.replaceState;function o(){location.pathname!==t&&(t=location.pathname,f())}history.pushState=function(...t){e.apply(this,t),o()},history.replaceState=function(...e){n.apply(this,e),o()},window.addEventListener("popstate",o)}(),f()}();